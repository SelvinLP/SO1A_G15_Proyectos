# gRPC-Go tutorial

<br>

## Prerequisites
Before you can follow this tutorial, you need to have the following installed on your system:
- **Go**: Version 1.14 or higher. 
For installation instructions, refer to Go s [Download and install](https://golang.org/doc/install "Download and install") documentation.

- **Protocol Buffer**: Version 3.
For installation instructions, refer to grpc's [Potocol Buffer Installation](https://grpc.io/docs/protoc-installation/ "Potocol Buffer Installation") or to the [Protocol Buffer](https://developers.google.com/protocol-buffers "Protocol Buffer") page.
<br>

## Running the example
To execute the example, download the code and move to the containing directory.

First start the grpc server with:

`$ go run sever/server.go`

This will start the grpc server listening on port 9000

Then, run the grpc client with:

`$ go run client/client.go`

You'll see the following output:

```
2021/03/07 15:04:39 Response from server: Hello gRPC Client From the Server!
```

and on the server you will see: 

```
gRPC Server
gRPC Server now listening on port 9000
2021/03/07 15:04:39 Received message from: gRPC Client
```
<br>

## Building the example 

First we need to initialize go modules, use any name you want, in this case we will use "grpcTutorial":

`$ go mod init grpcTutorial`

<br>

#### Go plugins for the Protocol Compiler

We need to install the next go plugins for the protocol compiler and grpc

Before installing we enable module mode with:

`$ export GO111MODULE=on`

Then install the following: 

1. Install protoc-gen-go

	`$ go get google.golang.org/protobuf/cmd/protoc-gen-go`

2. Install protoc-gen-go-grpc

	`$ go get google.golang.org/grpc/cmd/protoc-gen-go-grpc `

3. Install grpc

	`$ go get google.golang.org/grpc`
	
<br>

Finally update your `PATH` so that `protoc` can find the plugins:

`$ export PATH="$PATH:$(go env GOPATH)/bin"`

<br>

### Define a gRPC service

First we need to define the gRPC service and both the request and response types using protocol buffers.
<br>

#### Create .proto file 

Create a file named `chat.proto`:

```go
// Protoc version definition 
syntax = "proto3";

//Package definition
package chat;

//  Definition of the message to send/receive
message MessageRequest {
	string name = 1;
}

message MessageReply {
	string body = 1;
}

// The ChatService definition
service ChatService {
	// Receives a message and returns a message
	rpc SendMessage(MessageRequest) returns (MessageReply) {}
}
```

<br>

#### Generate gRPC code
Create a new directory called `chatserver`,  this will contain the code generated by `protoc`

`$ mkdir chatserver`

To be able tu use the service, you need to comiple the `.proto` file, we do this by using `protoc` with the following command:

``$ protoc --go-grpc_out=require_unimplemented_servers=false:./chatserver/ --go_out=./chatserver/ chat.proto``

This will generate `chat.pb.go` and `chat_grpc.pb.go` which are used by the grpc server.

<br>

### Create a gRPC Server

Inside `chatserver` create a new go file called `chat.go`

`touch chatserver/chat.go`

In this file we will implement the services that we defined previoulsy on the `chat.proto` file:

```go
//Package chat definition
package chat

//Imports
import (
	"context"
	"log"
)

//Server struct definition
type Server struct {
}

//SendMessage function implementation
func (s *Server) SendMessage(ctx context.Context, in *MessageRequest) (*MessageReply, error) {
	log.Printf("Received message from: %s", in.GetName())
	return &MessageReply{Body: "Hello " + in.GetName() + "From the Server!"}, nil
}
```
<br>

### Create a go Server

To use the service, we need to create a simple server using go.

Create a new directory called `server`

`$ mkdir server`

and inside create a new go file called `server.go`

`touch server/server.go`

In this file we are going to define a gRPC server using go:

```go
//Package main definition
package main

//Imports
import (
	"fmt"
	"log"
	"net"

	chat "grpcTutorial/chatserver"

	"google.golang.org/grpc"
)

//Main definition
func main() {
	println("gRPC Server")

	//Listening port definition, in this case port 9000
	lis, err := net.Listen("tcp", fmt.Sprintf(":%d", 9000))
	if err != nil {
		log.Fatalf("Failed to listen: %v", err)
	}

	println("gRPC Server now listening on port 9000")

	//New instance or the gRPC server
	grpcServer := grpc.NewServer()

	//Registrtion of the service with the gRPC server
	s := chat.Server{}
	chat.RegisterChatServiceServer(grpcServer, &s)

	//We call Serve() to start the service
	if err := grpcServer.Serve(lis); err != nil {
		log.Fatalf("Failed to serve: %s", err)
	}
}
```

<br>

If you try running the server, you should see the following output:

```
$ go run server/server.go
gRPC Server
gRPC Server now listening on port 9000
```

<br>

### Create gRPC Client
Lastly we need to create a gRPC Client to consume the service

Create a new folder called `client`

`$ mkdir client`

and inside create a new go file called `client.go`

`touch client/client.go`

In this file we are going to define a gRPC stub:

```go
//Package definition
package main

//Imports
import (
	"context"
	"log"

	chat "grpcTutorial/chatserver"

	"google.golang.org/grpc"
)

//Main definition
func main() {

	//We create a new Client and we assign credentials using  grpc.Dial
	//We assing the port where the server is listening, in this case port 9000
	var conn *grpc.ClientConn
	conn, err := grpc.Dial(":9000", grpc.WithInsecure())
	if err != nil {
		log.Fatalf("Did not connect: %s", err)
	}
	defer conn.Close()

	//Stub creation
	c := chat.NewChatServiceClient(conn)

	//Service method call, we send a MessageRequest and receive in response a MessageReply
	response, err := c.SendMessage(context.Background(), &chat.MessageRequest{Name: "gRPC Client"})
	if err != nil {
		log.Fatalf("Error when calling SendMessage: %s", err)
	}
	log.Printf("Response from server: %s", response.Body)
}
```

<br>

### Testing the client

First start the server:

`$ go run sever/server.go`

Then, run the client with:

`$ go run client/client.go`

You'll see the following output:

```
2021/03/07 15:04:39 Response from server: Hello gRPC Client From the Server!
```
and on the server you will see: 

```
gRPC Server
gRPC Server now listening on port 9000
2021/03/07 15:04:39 Received message from: gRPC Client
```

Congratulations! you now have a gRPC Server and Client using go.

<br>

## Imports warnings 
If you get any import warning or error try running: 

`$ go mod tidy`


